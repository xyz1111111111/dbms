CREATE TABLE EMPLOYEE (
    SSN CHAR(5) PRIMARY KEY,
    Fname VARCHAR(15),
    Lname VARCHAR(15),
    Address VARCHAR(15),
    Sex CHAR(1),
    Salary DECIMAL(8,2),
    SuperSSN CHAR(5),
    Dno INT
);


CREATE TABLE DEPARTMENT (
    Dno INT PRIMARY KEY,
    Dname VARCHAR(10),
    MgrSSN CHAR(5),
    MgrStartDate DATE
);


CREATE TABLE DLOCATION (
    Dno INT,
    Dloc VARCHAR(15),
    PRIMARY KEY (Dno, Dloc)
);


CREATE TABLE PROJECT (
    Pno INT(5) PRIMARY KEY,
    Pname VARCHAR(15),
    Plocation VARCHAR(15),
    Dno INT
);



CREATE TABLE WORKS_ON (
    SSN CHAR(5),
    Pno INT(5),
    Hours INT(2),
    PRIMARY KEY (SSN, Pno)
);



ALTER TABLE EMPLOYEE
ADD CONSTRAINT FKsuperssn FOREIGN KEY (SuperSSN)
REFERENCES EMPLOYEE(SSN);


ALTER TABLE EMPLOYEE
ADD CONSTRAINT FKdnumber FOREIGN KEY (Dno)
REFERENCES DEPARTMENT(Dno);


ALTER TABLE DEPARTMENT
ADD CONSTRAINT FKMgrSSN FOREIGN KEY (MgrSSN)
REFERENCES EMPLOYEE(SSN);


ALTER TABLE DLOCATION
ADD CONSTRAINT FKLocation FOREIGN KEY (Dno)
REFERENCES DEPARTMENT(Dno);


ALTER TABLE PROJECT
ADD CONSTRAINT FKProjDept FOREIGN KEY (Dno)
REFERENCES DEPARTMENT(Dno);


ALTER TABLE WORKS_ON
ADD CONSTRAINT FKWorksProj FOREIGN KEY (Pno)
REFERENCES PROJECT(Pno);


ALTER TABLE WORKS_ON
ADD CONSTRAINT FKWorksEmp FOREIGN KEY (SSN)
REFERENCES EMPLOYEE(SSN);

INSERT INTO EMPLOYEE VALUES
('CEC01', 'John', 'Scott', 'Dallas, Houston', 'M', 850000, NULL, NULL),
('CEC02', 'James', 'Borg', 'Voss, Houston', 'M', 770000, NULL, NULL),
('CEC03', 'Alicia', 'Zeleya', 'Castie, Spring', 'F', 780000, NULL, NULL),
('CEC04', 'Ramesh', 'Narayan', 'Banglore', 'M', 800000, NULL, NULL),
('CEC05', 'Reena', 'Sharma', 'Mumbai', 'F', 580000, NULL, NULL),
('CEC06', 'Aditya', 'Roy', 'Jaipur', 'M', 850000, NULL, NULL);


INSERT INTO DEPARTMENT VALUES
(1, 'AppDev', 'CEC01', '2000-06-01'),
(2, 'Accounts', 'CEC04', '2000-05-25'),
(3, 'Robotics', 'CEC06', '2015-02-05'),
(4, 'Testing', 'CEC01', '2000-05-25'),
(5, 'ES', 'CEC06', '2014-11-25');


UPDATE EMPLOYEE SET Dno = 1 WHERE SSN = 'CEC01';
UPDATE EMPLOYEE SET Dno = 3 WHERE SSN = 'CEC02';
UPDATE EMPLOYEE SET Dno = 4 WHERE SSN = 'CEC03';
UPDATE EMPLOYEE SET Dno = 2 WHERE SSN = 'CEC04';
UPDATE EMPLOYEE SET Dno = 5 WHERE SSN = 'CEC05';
UPDATE EMPLOYEE SET Dno = 3 WHERE SSN = 'CEC06';


UPDATE EMPLOYEE SET SuperSSN = 'CEC06' WHERE SSN = 'CEC01';
UPDATE EMPLOYEE SET SuperSSN = 'CEC01' WHERE SSN = 'CEC03';
UPDATE EMPLOYEE SET SuperSSN = 'CEC05' WHERE SSN = 'CEC02';
UPDATE EMPLOYEE SET SuperSSN = 'CEC06' WHERE SSN = 'CEC05';



INSERT INTO DLOCATION VALUES
(1, 'Texas'),
(2, 'Mumbai'),
(3, 'New Jersey'),
(3, 'Jaipur'),
(4, 'Bangalore'),
(5, 'New Jersey');


INSERT INTO PROJECT VALUES
(111, 'IOT', 'Bangalore', 1),
(222, 'INSAT', 'Jaipur', 5),
(333, 'UDAN', 'Jaipur', 5),
(444, 'MetalDetector', 'Texas', 3),
(555, 'WarFeildSpying', 'Texas', 3);


INSERT INTO WORKS_ON VALUES
('CEC01', 111, 30),
('CEC02', 222, 15),
('CEC02', 333, 15),
('CEC03', 444, 12),
('CEC03', 555, 18),
('CEC05', 333, 20),
('CEC05', 555, 10),
('CEC06', 222, 10),
('CEC06', 444, 20),
('CEC01', 555, 10);


SELECT DISTINCT P.Pno
FROM PROJECT P
JOIN DEPARTMENT D ON P.Dno = D.Dno
LEFT JOIN WORKS_ON WO ON P.Pno = WO.Pno
LEFT JOIN EMPLOYEE E ON WO.SSN = E.SSN OR D.MgrSSN = E.SSN
WHERE E.Lname = 'Scott';


SELECT E.FNAME, E.SALARY, 1.1 * E.SALARY AS INC_SALARY
FROM EMPLOYEE E
JOIN WORKS_ON W ON E.SSN = W.SSN
JOIN PROJECT P ON P.PNO = W.PNO
WHERE P.PNAME = 'IoT';


SELECT DNAME,
    SUM(E.Salary) AS Total_Salary,
    MAX(E.Salary) AS Max_Salary,
    MIN(E.Salary) AS Min_Salary,
    AVG(E.Salary) AS Avg_Salary
FROM 
    EMPLOYEE E
JOIN 
    DEPARTMENT D ON E.Dno = D.Dno
WHERE 
    D.Dname = 'Accounts';


SELECT DISTINCT E.Fname
FROM EMPLOYEE E
JOIN WORKS_ON W ON E.SSN = W.SSN
JOIN PROJECT P ON W.Pno = P.Pno
WHERE NOT EXISTS (
    SELECT P2.Pno
    FROM PROJECT P2
    WHERE P2.Dno = 5
    AND P2.Pno NOT IN (
        SELECT P3.Pno
        FROM WORKS_ON W2
        JOIN PROJECT P3 ON W2.Pno = P3.Pno
        WHERE E.SSN = W2.SSN
    )
);

SELECT Dno,COUNT(*) AS NumEmployees
FROM EMPLOYEE 
WHERE Dno IN (
        SELECT Dno 
        FROM EMPLOYEE 
        GROUP BY Dno 
        HAVING COUNT(*) > 5
        ) 
AND Salary > 600000 
GROUP BY Dno;


SELECT Dno,COUNT(*) 
FROM EMPLOYEE 
WHERE Dno IN (
        SELECT Dno 
        FROM EMPLOYEE 
        GROUP BY Dno 
        HAVING COUNT(*) > 1
    ) 
AND Salary > 600000 
GROUP BY Dno;